<!-- =========================
     BOOHA BLOCKS (UPDATED)
     FULL FILE (sound + glow + quiz)
     ========================= -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Booha Blocks ‚Äì Practice Deck</title>

  <link rel="icon" type="image/png" sizes="32x32" href="BooBlocks.png">
  <link rel="apple-touch-icon" href="BooBlocks.png">

  <!-- no pinch zoom -->
  <meta name="viewport"
        content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">

  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Noto+Sans+JP:wght@500;700&display=swap" rel="stylesheet">

  <style>
  :root{
    /* ‚úÖ Level theme colors will overwrite these via JS */
    --pink:#ff7eb9;
    --aqua:#7dd3fc;

    --gold:#ffd166;
    --outline:rgba(255,255,255,0.35);

    /* ‚úÖ reactive glow (JS updates) */
    --pulse:0;
    --pulse2:0;

    /* ‚úÖ extra flash for ‚Äúalive‚Äù feel */
    --flash:0;

    /* ‚úÖ NEW: full-screen bloom strength */
    --screenGlow:0;
  }

  /* RESET */
  *{margin:0;padding:0;box-sizing:border-box;}
 html,body{
  width:100%;
  height:100%;
  overflow:hidden;
}

html{
  height:100svh; /* ‚úÖ stable viewport height for mobile Safari */
}

body{
  margin:0;
  min-height:100svh; /* ‚úÖ stable height (fixes iPhone bottom bar chaos) */

  display:flex;
  align-items:flex-start;
  justify-content:center;

  /* ‚úÖ Always apply safe-area padding */
  padding-top:calc(2.5vh + env(safe-area-inset-top, 0px));
  padding-bottom:calc(2.5vh + env(safe-area-inset-bottom, 0px));
  padding-left:calc(12px + env(safe-area-inset-left, 0px));
  padding-right:calc(12px + env(safe-area-inset-right, 0px));

  /* ‚úÖ background glow reacts to clears */
  background:
    radial-gradient(circle at 50% 30%,
      rgba(255,255,255, calc(0.10 * var(--pulse))) 0%,
      rgba(0,0,0,0) 38%),
    radial-gradient(circle at 20% 15%,
      color-mix(in srgb, var(--pink) 60%, transparent) calc(10% * var(--pulse2)),
      transparent 45%),
    radial-gradient(circle at 80% 85%,
      color-mix(in srgb, var(--aqua) 60%, transparent) calc(10% * var(--pulse2)),
      transparent 50%),
    radial-gradient(circle at top, #1f2937 0%, #020617 55%, #000000 100%);

  font-family:'Noto Sans JP', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  color:#f9fafb;

  overflow:hidden;
  overscroll-behavior:none;
  -webkit-tap-highlight-color: transparent;
}

  /* ‚úÖ NEW: true whole-screen bloom layer (stronger than ::after) */
  body::before{
    content:"";
    position:fixed;
    inset:-6%;
    pointer-events:none;
    z-index:4;
    opacity:calc(0.14 * var(--screenGlow));
    background:
      radial-gradient(circle at 50% 45%,
        rgba(255,255,255,0.95) 0%,
        rgba(255,255,255,0.0) 58%),
      radial-gradient(circle at 20% 25%,
        color-mix(in srgb, var(--pink) 60%, transparent) 0%,
        transparent 60%),
      radial-gradient(circle at 80% 75%,
        color-mix(in srgb, var(--aqua) 60%, transparent) 0%,
        transparent 62%);
    filter:blur(22px);
    mix-blend-mode:screen;
    transition:opacity .08s ease;
  }

  /* ‚úÖ whole-screen flash when line clears (color) */
  body::after{
    content:"";
    position:fixed;
    inset:0;
    pointer-events:none;
    z-index:5;
    opacity:calc(0.18 * var(--flash));
    background:
      radial-gradient(circle at 30% 30%,
        color-mix(in srgb, var(--pink) 60%, transparent) 0%,
        transparent 55%),
      radial-gradient(circle at 70% 70%,
        color-mix(in srgb, var(--aqua) 60%, transparent) 0%,
        transparent 60%),
      radial-gradient(circle at 50% 50%,
        rgba(255,255,255,0.20) 0%,
        transparent 62%);
    filter:blur(14px);
    mix-blend-mode:screen;
    transition:opacity .10s ease;
  }

  /* PHONE SHELL */
  .shell{
    position:relative;
    padding:18px 22px 32px;
    border-radius:24px;
    background:radial-gradient(circle at top,rgba(148,163,255,0.25),rgba(15,23,42,0.98));
    border:1px solid rgba(148,163,255,0.5);
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;

    width:min(480px, 100vw - 24px);
    max-height:calc(100svh - (5vh + env(safe-area-inset-top, 0px) + env(safe-area-inset-bottom, 0px)));
    overflow:visible; /* ‚úÖ prevents inner layout from pushing controls off-screen */

  }

  /* ‚úÖ shell heartbeat on line clear */
  .shell.pulse-hit{ animation:shellPulse 0.06s ease-out; }
  @keyframes shellPulse{
    0%   { transform:scale(1); }
    50%  { transform:scale(1.035); }
    100% { transform:scale(1); }
  }

  /* iPhone Safari bottom bar fix */
  @supports (-webkit-touch-callout:none) {
    body{ padding-bottom:calc(4vh + env(safe-area-inset-bottom, 0px)); }
    .shell{ padding-bottom:calc(24px + env(safe-area-inset-bottom, 0px)); }
  }

  /* shell halo */
  .shell::before{
    content:"";
    position:absolute;
    inset:-2px;
    border-radius:26px;
    background:
      radial-gradient(circle at 0% 0%,rgba(236,72,153,0.27),transparent 60%),
      radial-gradient(circle at 100% 100%,rgba(56,189,248,0.24),transparent 60%);
    z-index:-1;
    filter:blur(10px);
    opacity:0.9;
    animation:orbGlow 6s ease-in-out infinite alternate;
  }

  /* ‚úÖ reactive shell glow on clears */
  .shell::after{
    content:"";
    position:absolute;
    inset:-6px;
    border-radius:30px;
    pointer-events:none;
    z-index:-2;
    filter:blur(14px);
    opacity:calc(0.12 + (0.68 * var(--pulse)) + (0.35 * var(--flash)));
    background:
      radial-gradient(circle at 30% 25%,
        color-mix(in srgb, var(--pink) 78%, transparent) 0%,
        transparent 55%),
      radial-gradient(circle at 70% 75%,
        color-mix(in srgb, var(--aqua) 78%, transparent) 0%,
        transparent 60%),
      radial-gradient(circle at 50% 50%,
        rgba(255,255,255,0.20) 0%,
        transparent 60%);
    transition:opacity .10s ease;
  }

  @keyframes orbGlow{
    0%{transform:translate3d(-4px,-4px,0) scale(1);}
    100%{transform:translate3d(4px,4px,0) scale(1.02);}
  }

  /* scale hub down on short screens */
  @media (max-height:780px){
    .shell{ transform:scale(0.9); transform-origin: top center; }
  }
  @media (max-height:700px){
    .shell{ transform:scale(0.82); transform-origin: top center; }
  }

  /* TITLE */
  h1{
    font-family:'Cinzel',serif;
    font-weight:900;
    letter-spacing:0.12em;
    font-size:1.05rem;
    text-transform:uppercase;
    text-align:center;
    color:#e5e7eb;
    text-shadow:
      0 0 8px rgba(248,250,252,0.9),
      0 0 16px rgba(251,113,133,0.8);
  }
  h1 span{
    display:block;
    font-size:0.8rem;
    letter-spacing:0.28em;
    color:#a5b4fc;
    text-shadow:none;
    margin-top:2px;
  }

  /* TOP BUTTONS */
  #helpBtn,#trophyBtn,#pauseBtn{
    position:absolute;
    top:8px;
    width:36px;
    height:36px;
    border-radius:50%;
    border:1px solid var(--gold);
    background:linear-gradient(135deg,var(--pink),var(--aqua));
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:20px;
    cursor:pointer;
    box-shadow:0 0 12px rgba(255,255,255,0.7);
    z-index:15;
  }
  #helpBtn{left:8px;}
  #trophyBtn{right:52px;}
  #pauseBtn{right:8px;}

  /* HUD */
  .hud-row{
    width:100%;
    display:flex;
    justify-content:space-between;
    font-size:0.8rem;
    color:#e5e7eb;
  }
  .hud-row .label{opacity:0.8;}
  .hud-row .value{
    color:var(--gold);
    text-shadow:0 0 6px #ffd166;
  }
  .hud-row .next{
    color:var(--pink);
    text-shadow:0 0 6px color-mix(in srgb, var(--pink) 70%, white);
  }

  /* GAME CANVAS */
  #game{
    margin-top:8px;
    border-radius:18px;
    border:1px solid var(--outline);
    background:radial-gradient(circle at top,#020617 0%,#000 50%,#020617 100%);
    /* ‚úÖ glow reacts to clears + level colors */
    box-shadow:
      0 0 calc(18px + (26px * var(--pulse))) color-mix(in srgb, var(--aqua) 55%, transparent),
      0 0 calc(38px + (60px * var(--pulse))) rgba(15,23,42,0.9),
      0 0 calc(10px + (22px * var(--pulse))) color-mix(in srgb, var(--pink) 45%, transparent),
      0 0 calc(18px + (38px * var(--flash))) rgba(255,255,255,0.28);
    image-rendering:pixelated;
    touch-action:none;
    height:min(62svh, 640px);
    width:auto;
    max-width:100%;
    display:block;

  }

  /* SPARKLES */
  .sparkle-overlay{
    pointer-events:none;
    position:absolute;
    inset:0;
    overflow:hidden;
    border-radius:24px;
    mix-blend-mode:screen;
    opacity:0.45;
  }
  .spark{
    position:absolute;
    width:3px;height:3px;border-radius:50%;
    background:radial-gradient(circle,#e5e7eb 0%,rgba(244,244,245,0) 70%);
    box-shadow:0 0 8px rgba(255,255,255,0.9);
    animation:floatUp 8s linear infinite;
  }
  .spark:nth-child(2){animation-duration:10s;}
  .spark:nth-child(3){animation-duration:12s;}
  .spark:nth-child(4){animation-duration:9s;}
  .spark:nth-child(5){animation-duration:11s;}
  .spark:nth-child(6){animation-duration:13s;}
  @keyframes floatUp{
    0%{transform:translate3d(0,120%,0) scale(0.6); opacity:0;}
    18%{opacity:1;}
    80%{opacity:1;}
    100%{transform:translate3d(0,-40%,0) scale(1.05); opacity:0;}
  }

  /* MOBILE CONTROLS */
#mobileControls{
  display:none;
  width:100%;
  justify-content:center;
  gap:12px;
  margin-top:8px;
}

/* ‚Üì row is separate and compact */
#mobileDownRow{
  display:none;
  width:100%;
  justify-content:center;
  margin-top:6px;
}

/* default circular buttons */
.mob-btn{
  width:52px;
  height:52px;
  border-radius:50%;
  border:1px solid var(--gold);
  background:linear-gradient(135deg,var(--pink),var(--aqua));
  box-shadow:0 0 12px rgba(255,255,255,0.7);
  font-size:22px;
  color:#111827;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  touch-action:manipulation;
}

/* keep your special rotate style */
#rotateBtn{
  background:radial-gradient(circle at 30% 20%, #fdf2ff, #e879f9 40%, #a855f7 80%);
  box-shadow:0 0 18px rgba(232,121,249,0.9);
}

/* ‚¨á SPACE-BAR STYLE DOWN BUTTON */
#moveDownBtn{
  width:100%;
  max-width:260px;
  height:44px;
  border-radius:14px;
  font-size:18px;
  font-weight:900;

  background:linear-gradient(180deg,#fde68a,#f59e0b);
  color:#1f2937;

  box-shadow:
    0 6px 18px rgba(245,158,11,0.6),
    inset 0 1px 0 rgba(255,255,255,0.6);
}

#moveDownBtn:active{
  transform:translateY(1px);
  box-shadow:
    0 3px 10px rgba(245,158,11,0.8),
    inset 0 2px 4px rgba(0,0,0,0.25);
}

       
#moveDownBtn:active{
  transform:translateY(1px);
  box-shadow:
    0 3px 10px rgba(245,158,11,0.8),
    inset 0 2px 4px rgba(0,0,0,0.25);
}

/* ‚úÖ show controls only on real touch devices */
@media (hover:none) and (pointer:coarse){
  #mobileControls,
  #mobileDownRow{
    display:flex;
  }
}

/* ‚úÖ give the phone shell extra bottom room for the ‚Üì bar */
@media (hover:none) and (pointer:coarse){
  .shell{
    padding-bottom:74px;
  }
}

@media (pointer:coarse){
  .shell{ padding-bottom:86px; }  /* space for the ‚Üì bar */
  #game{ height:min(56svh, 620px); } /* free space so ‚Üì never gets pushed out */
}
       

  /* PAUSE OVERLAY */
  #pauseOverlay{
    position:absolute;inset:0;border-radius:24px;
    background:rgba(0,0,0,0.6);
    display:none;align-items:center;justify-content:center;
    z-index:25;font-size:0.95rem;text-shadow:0 0 6px #fff;
  }

  /* HELP OVERLAY */
  #helpOverlay{
    position:absolute;inset:0;border-radius:24px;
    background:rgba(0,0,15,0.8);
    backdrop-filter:blur(6px);
    display:none;align-items:center;justify-content:center;
    z-index:30;
  }
  .help-card{
    width:88%;max-width:380px;
    padding:18px 20px 16px;border-radius:18px;
    background:radial-gradient(circle,#111827,#020617 60%);
    border:1px solid rgba(255,255,255,0.25);
    position:relative;color:#e5e7eb;font-size:0.8rem;
  }
  .help-title{
    font-family:'Cinzel';
    text-align:center;font-size:1.1rem;margin-bottom:8px;
  }
  #helpClose{
    position:absolute;top:8px;right:8px;width:26px;height:26px;
    border-radius:50%;
    background:linear-gradient(135deg,var(--pink),var(--aqua));
    border:1px solid var(--gold);
    display:flex;align-items:center;justify-content:center;
    font-size:16px;cursor:pointer;
    box-shadow:0 0 8px rgba(255,255,255,0.7);
  }

  /* LEADERBOARD */
  #leaderboardOverlay{
    position:absolute;inset:0;border-radius:24px;
    background:rgba(0,0,15,0.9);
    backdrop-filter:blur(6px);
    display:none;align-items:center;justify-content:center;
    z-index:32;
  }
  .leader-card{
    width:88%;max-width:360px;
    padding:18px 20px 16px;border-radius:18px;
    background:radial-gradient(circle,#020617,#020617 60%);
    border:1px solid rgba(255,255,255,0.25);
    color:#e5e7eb;position:relative;font-size:0.8rem;
  }
  .leader-title{
    font-family:'Cinzel';
    text-align:center;font-size:1.05rem;margin-bottom:8px;
  }
  #leaderClose{
    position:absolute;top:8px;right:8px;width:26px;height:26px;
    border-radius:50%;
    background:linear-gradient(135deg,var(--pink),var(--aqua));
    border:1px solid var(--gold);
    display:flex;align-items:center;justify-content:center;
    font-size:16px;cursor:pointer;
    box-shadow:0 0 8px rgba(255,255,255,0.7);
  }
  #leaderboardList{margin-top:4px;line-height:1.6;}

  /* QUESTION OVERLAY */
  #questionOverlay{
    position:fixed;inset:0;
    background:rgba(0,0,20,0.82);
    backdrop-filter:blur(8px);
    display:none;align-items:center;justify-content:center;
    z-index:50;
  }

  .q-card{
    width:min(92vw,520px);
    border-radius:22px;
    padding:18px 18px 16px;
    position:relative;
    overflow:hidden;
    background:
      radial-gradient(circle at top, rgba(255,255,255,0.10), transparent 45%),
      radial-gradient(circle at 20% 10%, color-mix(in srgb, var(--pink) 45%, transparent) 0%, transparent 55%),
      radial-gradient(circle at 85% 90%, color-mix(in srgb, var(--aqua) 45%, transparent) 0%, transparent 60%),
      radial-gradient(circle at top,#111827,#020617 65%,#020617 100%);
    border:1px solid rgba(248,250,252,0.28);
    box-shadow:
      0 0 26px color-mix(in srgb, var(--pink) 55%, transparent),
      0 0 70px color-mix(in srgb, var(--aqua) 45%, transparent);
    color:#f9fafb;
  }

  .q-card::before{
    content:"";
    position:absolute;
    left:-30%;
    top:-40px;
    width:160%;
    height:120px;
    background:linear-gradient(90deg,
      transparent,
      color-mix(in srgb, var(--pink) 65%, transparent),
      color-mix(in srgb, var(--aqua) 65%, transparent),
      transparent);
    opacity:.55;
    transform:rotate(-6deg);
    animation:qSweep 3.8s ease-in-out infinite;
  }
  @keyframes qSweep{
    0%{transform:translateX(-12%) rotate(-6deg);}
    50%{transform:translateX(12%) rotate(-6deg);}
    100%{transform:translateX(-12%) rotate(-6deg);}
  }

  .q-card::after{
    content:"";
    position:absolute;inset:0;
    background:
      radial-gradient(circle at 15% 25%, rgba(255,255,255,.18) 0 2px, transparent 3px),
      radial-gradient(circle at 70% 35%, rgba(255,255,255,.14) 0 2px, transparent 3px),
      radial-gradient(circle at 40% 80%, rgba(255,255,255,.12) 0 2px, transparent 3px),
      radial-gradient(circle at 85% 70%, rgba(255,255,255,.15) 0 2px, transparent 3px);
    opacity:.6;
    mix-blend-mode:screen;
    pointer-events:none;
  }

  .q-title{
    font-family:'Cinzel',serif;
    font-weight:900;
    letter-spacing:.10em;
    text-align:center;
    margin-bottom:6px;
    position:relative;
    z-index:1;
    text-shadow:0 0 10px rgba(255,255,255,.35);
  }
  .q-sub{
    text-align:center;
    font-size:.82rem;
    opacity:.9;
    margin-bottom:12px;
    position:relative;
    z-index:1;
  }
  #questionText{
    font-size:1.05rem;
    line-height:1.45;
    margin:8px 0 12px;
    position:relative;
    z-index:1;
    text-shadow:0 0 10px rgba(0,0,0,.35);
  }
 /* ==============================
   QUESTION CHOICES (MOBILE SAFE)
   ============================== */

#choiceWrap{
  display:grid;
  grid-template-columns: repeat(2, minmax(0,1fr));
  gap:14px;                 /* ‚úÖ space between tiles */
  margin-top:10px;
  padding:14px;
  width:min(560px, 92vw);
  margin-left:auto;
  margin-right:auto;
  position:relative;
  z-index:1;
}

.choiceBtn{
  appearance:none;
  border:1px solid rgba(255,255,255,.22);
  background:rgba(255,255,255,.08);
  color:#f9fafb;

  min-height:58px;          /* ‚úÖ bigger tap target */
  padding:14px 14px;
  border-radius:16px;

  font-weight:800;
  cursor:pointer;
  text-align:left;
  line-height:1.15;

  touch-action:manipulation;
  -webkit-tap-highlight-color: transparent;

  box-shadow:0 10px 24px rgba(0,0,0,.25);
  transition:transform .08s ease, background .12s ease, border-color .12s ease, box-shadow .12s ease;
}

.choiceBtn:active{ transform:scale(.98); }

@media (max-width: 420px){
  #choiceWrap{
    grid-template-columns: 1fr;  /* ‚úÖ single column on tiny screens */
    gap:12px;
    padding:12px;
  }
  .choiceBtn{
    min-height:60px;
    font-size:18px;
  }
}

  .choiceBtn:active{transform:scale(.98);}
  .choiceBtn.correct{
    background:rgba(34,197,94,.22);
    border-color:rgba(34,197,94,.65);
    box-shadow:0 0 16px rgba(34,197,94,.35);
  }
  .choiceBtn.wrong{
    background:rgba(239,68,68,.18);
    border-color:rgba(239,68,68,.55);
    box-shadow:0 0 16px rgba(239,68,68,.25);
  }
  .q-note{
    font-size:.8rem;
    opacity:.92;
    margin-top:10px;
    text-align:center;
    position:relative;
    z-index:1;
  }

  /* START OVERLAY */
  #startOverlay{
    position:fixed;inset:0;
    background:rgba(0,0,10,0.85);
    display:flex;align-items:center;justify-content:center;
    z-index:60;text-align:center;
  }
  #startOverlayInner{
    padding:20px 18px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,0.3);
    background:radial-gradient(circle,#111827,#020617 60%);
    box-shadow:0 0 30px rgba(59,130,246,0.8);
    font-size:0.95rem;
  }
  #startOverlayInner .big{
    display:block;
    font-size:1.6rem;
    margin-bottom:6px;
  }
  </style>
</head>
<body>

<!-- Tap-to-start -->
<div id="startOverlay">
  <div id="startOverlayInner">
    <span class="big">ÁîªÈù¢„Çí„Çø„ÉÉ„Éó„Åó„Å¶„Çπ„Çø„Éº„Éà</span>
    „Éñ„É≠„ÉÉ„ÇØ„ÇíÂãï„Åã„Åó„Å¶„É©„Ç§„É≥„ÇíÊ∂à„Åù„ÅÜÔºÅ<br>
    Ôºï„É©„Ç§„É≥„Åî„Å®„Å´„Éñ„Éº„Éè„ÇØ„Ç§„Ç∫„ÅåÂá∫„Å¶„Åè„Çã„Çà„ÄÇ
  </div>
</div>

<div class="shell">

  <h1>
    BOOHA BLOCKS
    <span>„Éñ„Éº„Éè„Éº„Éª„Éñ„É≠„ÉÉ„ÇØ„Çπ</span>
  </h1>

  <div id="helpBtn">Ôºü</div>
  <div id="trophyBtn">üèÜ</div>
  <div id="pauseBtn">‚è∏</div>

  <div class="hud-row">
    <div>
      <span class="label">„É©„Ç§„É≥Ôºö</span>
      <span class="value" id="linesCount">0</span>
    </div>
    <div>
      <span class="label">Ê¨°„ÅÆ„ÇØ„Ç§„Ç∫Ôºö</span>
      <span class="next" id="nextAt">5</span>
      <span class="label">„É©„Ç§„É≥</span>
    </div>
  </div>

  <div class="hud-row">
    <div>
      <span class="label">„Çπ„Ç≥„Ç¢Ôºö</span>
      <span class="value" id="scoreValue">0</span>
    </div>
    <div></div>
  </div>

  <canvas id="game" width="320" height="640"></canvas>

  <div class="sparkle-overlay">
    <div class="spark" style="left:10%;"></div>
    <div class="spark" style="left:30%;"></div>
    <div class="spark" style="left:50%;"></div>
    <div class="spark" style="left:70%;"></div>
    <div class="spark" style="left:85%;"></div>
    <div class="spark" style="left:42%;"></div>
  </div>

  <div id="pauseOverlay"><div>„Çø„ÉÉ„Éó„Åó„Å¶„Ç≤„Éº„É†„Å´Êàª„Çã</div></div>

  <div id="helpOverlay">
    <div class="help-card">
      <div id="helpClose">‚úï</div>
      <div class="help-title">How to Play Ôºè ÈÅä„Å≥Êñπ</div>
      <div class="help-text">
        <p>‚óè Â∑¶ ‚Üê „Å® Âè≥ ‚Üí „Éú„Çø„É≥„Åß„Éñ„É≠„ÉÉ„ÇØ„ÇíÂãï„Åã„Åô„ÄÇ</p>
        <p>‚óè „Éî„É≥„ÇØ„ÅÆÂõûËª¢„Éú„Çø„É≥„Åß„Éñ„É≠„ÉÉ„ÇØ„ÇíÂõû„Åô„ÄÇ</p>
        <p>‚óè ‰∏ã „Éú„Çø„É≥„Çí„Äå„Çø„ÉÉ„Éó„Äç„Åô„Çã„Å®1„Éû„Çπ‰∏ã„Å´ËêΩ„Å°„Çã„ÄÇ</p>
        <p>‚óè ‰∏ã „Éú„Çø„É≥„Çí„ÄåÈï∑Êäº„Åó„Äç„Åô„Çã„Å®„ÄÅ„Åô„Å∞„ÇÑ„ÅèËêΩ„Å°„ÇãÔºà„ÇΩ„Éï„Éà„Éâ„É≠„ÉÉ„ÉóÔºâ„ÄÇ</p>
        <br>
        <p>‚óè Use ‚Üê and ‚Üí to move the block.</p>
        <p>‚óè Use the pink button to rotate the block.</p>
        <p>‚óè Tap the ‚Üì button to drop 1 square.</p>
        <p>‚óè Hold the ‚Üì button to accelerate the fall (soft-drop).</p>
        <br>
        <p>5„É©„Ç§„É≥„Åî„Å®„Å´„ÇØ„Ç§„Ç∫„ÅåÂá∫„Çã„ÇàÔºÅ</p>
      </div>
    </div>
  </div>

  <div id="leaderboardOverlay">
    <div class="leader-card">
      <div id="leaderClose">‚úï</div>
      <div class="leader-title">„É≠„Éº„Ç´„É´„Éª„Éè„Ç§„Çπ„Ç≥„Ç¢</div>
      <div id="leaderboardList">„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì</div>
    </div>
  </div>

  <div id="mobileControls">
    <div class="mob-btn" id="moveLeftBtn">‚Üê</div>
    <div class="mob-btn" id="rotateBtn">‚Üª</div>
    <div class="mob-btn" id="moveRightBtn">‚Üí</div>
  </div>

  <div id="mobileDownRow">
    <div class="mob-btn" id="moveDownBtn">‚Üì</div>
  </div>

</div>

<!-- QUESTION OVERLAY -->
<div id="questionOverlay">
  <div class="q-card">
    <div class="q-title">Checkpoint</div>
    <div class="q-sub">Booha Question Gate</div>

    <div id="questionText"></div>
    <div class="choices" id="choiceWrap"></div>

    <div class="q-note" id="qNote">‚Äª Ê≠£Ëß£„Åô„Çã„Åæ„ÅßÈÄ≤„ÇÅ„Åæ„Åõ„ÇìÔºà1ÂõûÁõÆ„ÅßÊ≠£Ëß£„Å™„Çâ +100Ôºâ</div>
  </div>
</div>

<script>
/* ==============================
   BOOHA BLOCKS: GAME CORE
   ============================== */

/* iOS pinch zoom guard */
document.addEventListener('gesturestart', e => e.preventDefault());

/* canvas */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const grid = 32;

/* state */
let gameStarted = false;
let gameOver = false;
let isPaused = false;
let isPausedForQuestion = false;

let score = 0;
let linesClearedTotal = 0;

let gravityFrames = 40;
let frameCounter = 0;

/* loop safety */
let rafId = 0;

/* ==============================
   AUDIO (same folder) ‚úÖ FIXED
   ============================== */
let audioUnlocked = false;

/* audio files */
const AUDIO_FILES = {
  bgm: "booha-tetris-january.mp3",
  lineClear: "booha-tetris-sound.mp3",
  quizOpen: "quiz.mp3",
  quizCorrect: "clear.mp3",
  levelUp: "correct.mp3",
};

/* persistent audio objects (use for longer sounds + no overlap needed) */
const SFX = {
  bgm: new Audio(AUDIO_FILES.bgm),
  quizOpen: new Audio(AUDIO_FILES.quizOpen),
  quizCorrect: new Audio(AUDIO_FILES.quizCorrect),
  levelUp: new Audio(AUDIO_FILES.levelUp),
};

/* configure */
SFX.bgm.loop = true;
SFX.bgm.preload = "auto";
SFX.bgm.volume = 0.28;

SFX.quizOpen.preload = "auto";
SFX.quizOpen.volume = 0.90;

SFX.quizCorrect.preload = "auto";
SFX.quizCorrect.volume = 0.90;

SFX.levelUp.preload = "auto";
SFX.levelUp.volume = 0.90;

/* robust play helper */
async function safePlay(audio, opts={}){
  if(!audioUnlocked || !audio) return;

  const restart = opts.restart !== false; // default true
  try{
    if(restart){
      try{ audio.pause(); audio.currentTime = 0; }catch(_){}
    }
    const p = audio.play();
    if(p && typeof p.catch === "function") p.catch(()=>{});
  }catch(_){}
}

/* Safari-safe one-shot SFX (fresh instance) */
function playSFX(url, vol=1){
  if(!audioUnlocked) return;
  try{
    const a = new Audio(url);
    a.preload = "auto";
    a.volume = vol;
    try{ a.currentTime = 0; }catch(_){}
    const p = a.play();
    if(p && typeof p.catch === "function") p.catch(()=>{});
  }catch(_){}
}

/* prime short silent play to unlock on iOS */
async function primeUrl(url){
  try{
    const a = new Audio(url);
    a.preload = "auto";
    a.volume = 0.0001;
    const p = a.play();
    if(p && typeof p.then === "function"){
      await p;
      a.pause();
      a.currentTime = 0;
    }
  }catch(_){}
}

/* ‚úÖ ONE unlockAudioOnce (no duplicates) */
async function unlockAudioOnce(){
  if(audioUnlocked) return;
  audioUnlocked = true;

  // warm/prime small clips (prevents ‚Äúno sound ever‚Äù on iOS)
  await primeUrl(AUDIO_FILES.lineClear);
  await primeUrl(AUDIO_FILES.quizOpen);
  await primeUrl(AUDIO_FILES.quizCorrect);
  await primeUrl(AUDIO_FILES.levelUp);

  // start BGM
  await safePlay(SFX.bgm, {restart:false});
}

/* pause/resume BGM with UI pauses */
function pauseBGM(){
  try{ SFX.bgm.pause(); }catch(_){}
}
function resumeBGM(){
  if(!audioUnlocked) return;
  if(gameOver) return;
  if(!gameStarted) return;
  if(isPaused || isPausedForQuestion) return;
  safePlay(SFX.bgm, {restart:false});
}

/* ==============================
   LEVEL THEMES
   ============================== */
const LEVEL_THEMES = [
  {p:"#7dd3fc", s:"#a7f3d0"},
  {p:"#f472b6", s:"#93c5fd"},
  {p:"#34d399", s:"#fde047"},
  {p:"#a855f7", s:"#f59e0b"},
  {p:"#fb7185", s:"#22c55e"},
  {p:"#06b6d4", s:"#f97316"},
  {p:"#e879f9", s:"#7dd3fc"},
  {p:"#facc15", s:"#60a5fa"},
];

let currentLevel = 1;
function calcLevel(){ return Math.max(1, 1 + Math.floor(linesClearedTotal / 10)); }

function applyLevelThemeAndMaybeSound(){
  const lvl = calcLevel();
  if(lvl === currentLevel) return;

  safePlay(SFX.levelUp);
  currentLevel = lvl;

  const t = LEVEL_THEMES[(lvl - 1) % LEVEL_THEMES.length];
  document.documentElement.style.setProperty("--pink", t.p);
  document.documentElement.style.setProperty("--aqua", t.s);
}

/* ==============================
   REACTIVE GLOW
   ============================== */
let pulse = 0;
let pulse2 = 0;
let flash = 0;
let screenGlow = 0;

function bumpGlow(lines){
  pulse      = Math.min(1.55, pulse      + 0.26 + 0.16 * lines);
  pulse2     = Math.min(1.20, pulse2     + 0.20 + 0.10 * lines);
  flash      = Math.min(1.35, flash      + 0.72 + 0.16 * lines);
  screenGlow = Math.min(1.60, screenGlow + 0.95 + 0.22 * lines);

  if(lines === 4){
    flash      = Math.min(2.0, flash + 0.8);
    screenGlow = Math.min(2.2, screenGlow + 1.2);
    pulse      = Math.min(1.9, pulse + 0.6);
  }

  const shell = document.querySelector(".shell");
  if(shell){
    shell.classList.remove("pulse-hit");
    void shell.offsetWidth;
    shell.classList.add("pulse-hit");
  }
}

function tickGlow(){
  pulse *= 0.90;
  pulse2 *= 0.965;
  flash *= 0.78;
  screenGlow *= 0.70;

  document.documentElement.style.setProperty("--pulse",  pulse.toFixed(3));
  document.documentElement.style.setProperty("--pulse2", pulse2.toFixed(3));
  document.documentElement.style.setProperty("--flash",  flash.toFixed(3));
  document.documentElement.style.setProperty("--screenGlow", screenGlow.toFixed(3));
}

/* HUD */
const linesEl = document.getElementById("linesCount");
const scoreEl = document.getElementById("scoreValue");
const nextAtEl = document.getElementById("nextAt");

let currentQuestionIndex = 0;

function updateHud(){
  linesEl.textContent = linesClearedTotal;
  scoreEl.textContent = score;
  nextAtEl.textContent = (currentQuestionIndex + 1) * 5;
}

/* playfield */
const playfield = [];
for(let r = -2; r < 20; r++){
  playfield[r] = Array(10).fill(0);
}

/* pieces */
const tetrominos = {
  I:[[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]],
  J:[[1,0,0],[1,1,1],[0,0,0]],
  L:[[0,0,1],[1,1,1],[0,0,0]],
  O:[[1,1],[1,1]],
  S:[[0,1,1],[1,1,0],[0,0,0]],
  Z:[[1,1,0],[0,1,1],[0,0,0]],
  T:[[0,1,0],[1,1,1],[0,0,0]]
};
const colors = {
  I:"#7dd3fc", O:"#facc15", T:"#e879f9",
  S:"#4ade80", Z:"#fb7185", J:"#a855f7", L:"#f97316"
};

/* bag random */
const bag = [];
function refillBag(){
  const pieces = Object.keys(tetrominos);
  while(pieces.length){
    const i = Math.floor(Math.random() * pieces.length);
    bag.push(pieces.splice(i,1)[0]);
  }
}
function nextPiece(){
  if(!bag.length) refillBag();
  const name = bag.pop();
  const matrix = tetrominos[name];
  return {
    name,
    matrix,
    row: name === "I" ? -1 : -2,
    col: 10/2 - Math.ceil(matrix[0].length/2)
  };
}
let piece = nextPiece();

/* collision */
function valid(matrix,row,col){
  for(let r=0;r<matrix.length;r++){
    for(let c=0;c<matrix[r].length;c++){
      if(matrix[r][c]){
        if(
          col+c < 0 ||
          col+c >= 10 ||
          row+r >= 20 ||
          playfield[row+r]?.[col+c]
        ) return false;
      }
    }
  }
  return true;
}

/* rotate */
function rotate(m){
  return m[0].map((_,i)=>m.map(r=>r[i]).reverse());
}

/* scoring */
function scoreLines(lines){
  if(lines <= 0) return;
  const points = 10 * (2 ** (lines - 1));
  score += points;
}

/* speed scaling */
function updateGravity(){
  gravityFrames = Math.max(8, 40 - Math.floor(score / 200));
}

/* ==============================
   LINE CLEAR FX
   ============================== */
let isClearingLines = false;
let clearingRows = [];
let clearTicks = 0;

const particles = [];
function spawnClearParticles(rows){
  rows.forEach(r=>{
    for(let i=0;i<26;i++){
      const x = (Math.random()*10) * grid + (Math.random()*8);
      const y = r * grid + (Math.random()*grid);
      particles.push({
        x, y,
        vx: (Math.random()-0.5) * 1.6,
        vy: - (0.6 + Math.random()*2.0),
        life: 1.0,
        decay: 0.035 + Math.random()*0.03,
        size: 1.6 + Math.random()*2.6
      });
    }
  });
}

function drawParticles(){
  if(!particles.length) return;
  for(let i=particles.length-1;i>=0;i--){
    const p = particles[i];
    p.x += p.vx;
    p.y += p.vy;
    p.vy += 0.04;
    p.life -= p.decay;

    if(p.life <= 0){
      particles.splice(i,1);
      continue;
    }

    const a = Math.max(0, Math.min(1, p.life));
    ctx.save();
    ctx.globalAlpha = 0.85 * a;
    ctx.fillStyle = "rgba(255,255,255,1)";
    ctx.shadowBlur = 10;
    ctx.shadowColor = "rgba(255,255,255,0.9)";
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
    ctx.fill();

    ctx.globalAlpha = 0.35 * a;
    ctx.shadowBlur = 14;
    ctx.shadowColor = "rgba(255,209,102,0.9)";
    ctx.fillStyle = "rgba(255,209,102,1)";
    ctx.beginPath();
    ctx.arc(p.x+0.6, p.y-0.6, p.size*0.55, 0, Math.PI*2);
    ctx.fill();
    ctx.restore();
  }
}

function shimmerRowOverlay(r, t){
  const y = r * grid;
  const phase = (t % 1);
  const sweepX = (-grid*2) + phase * (canvas.width + grid*4);

  ctx.save();
  ctx.globalCompositeOperation = "screen";
  ctx.globalAlpha = 0.45;

  const g = ctx.createLinearGradient(sweepX, y, sweepX + grid*4, y);
  g.addColorStop(0, "rgba(255,255,255,0)");
  g.addColorStop(0.45, "rgba(255,255,255,0.9)");
  g.addColorStop(1, "rgba(255,255,255,0)");

  ctx.fillStyle = g;
  ctx.fillRect(0, y, canvas.width, grid);

  ctx.globalAlpha = 0.18 + 0.18*Math.sin((Date.now()/60) + r);
  ctx.fillStyle = "rgba(255,209,102,1)";
  for(let i=0;i<6;i++){
    const x = (i*54 + (Date.now()/6)%54) % canvas.width;
    ctx.fillRect(x, y + 4 + (i%3), 2, 2);
  }

  ctx.restore();
}

/* lock */
function lockPiece(){
  for(let r=0;r<piece.matrix.length;r++){
    for(let c=0;c<piece.matrix[r].length;c++){
      if(piece.matrix[r][c]){
        if(piece.row+r < 0){
          gameOver = true;
          pauseBGM();
          return;
        }
        playfield[piece.row+r][piece.col+c] = piece.name;
      }
    }
  }

  const fullRows = [];
  for(let r=0;r<20;r++){
    if(playfield[r].every(Boolean)) fullRows.push(r);
  }

  if(fullRows.length){
    isClearingLines = true;
    clearingRows = fullRows.slice();
    clearTicks = 12;

    // ‚úÖ LINE CLEAR SFX (fresh instance)
    playSFX(AUDIO_FILES.lineClear, 0.78);

    bumpGlow(fullRows.length);
    spawnClearParticles(fullRows);

    return;
  }

  piece = nextPiece();
  updateHud();
}

/* remove cleared rows after shimmer */
function commitLineClear(){
  const rowsToClear = clearingRows.slice().sort((a,b)=>b-a);
  const cleared = rowsToClear.length;

  rowsToClear.forEach(r=>{ playfield.splice(r, 1); });
  for(let i=0;i<cleared;i++){ playfield.unshift(Array(10).fill(0)); }

  if(cleared){
    linesClearedTotal += cleared;
    scoreLines(cleared);
    updateGravity();
    applyLevelThemeAndMaybeSound();

    requestAnimationFrame(()=>{
      setTimeout(()=>{ maybeTriggerQuestion(); }, 180);
    });
  }

  isClearingLines = false;
  clearingRows = [];
  piece = nextPiece();
  updateHud();
}

/* draw */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  for(let r=0;r<20;r++){
    for(let c=0;c<10;c++){
      const cell = playfield[r][c];
      ctx.fillStyle = cell ? colors[cell] : "#020617";
      ctx.fillRect(c*grid,r*grid,grid-1,grid-1);
    }
  }

  if(isClearingLines && clearingRows.length){
    const t = (12 - clearTicks) / 12;
    clearingRows.forEach(r=>{
      ctx.save();
      ctx.globalCompositeOperation = "screen";
      ctx.globalAlpha = 0.18 + 0.22*Math.sin((Date.now()/70) + r);
      ctx.fillStyle = "rgba(255,255,255,1)";
      ctx.fillRect(0, r*grid, canvas.width, grid);
      ctx.restore();

      shimmerRowOverlay(r, t);
    });
  }

  ctx.fillStyle = colors[piece.name];
  piece.matrix.forEach((row,r)=>{
    row.forEach((v,c)=>{
      if(v){
        ctx.fillRect(
          (piece.col+c)*grid,
          (piece.row+r)*grid,
          grid-1,grid-1
        );
      }
    });
  });

  drawParticles();
}

/* main loop */
function loop(){
  if(gameOver || isPaused || isPausedForQuestion || !gameStarted) return;

  tickGlow();

  if(isClearingLines){
    clearTicks--;
    draw();
    if(clearTicks <= 0){
      commitLineClear();
    }
    rafId = requestAnimationFrame(loop);
    return;
  }

  frameCounter++;
  if(frameCounter >= gravityFrames){
    frameCounter = 0;
    if(valid(piece.matrix, piece.row+1, piece.col)){
      piece.row++;
    }else{
      lockPiece();
    }
  }

  draw();
  rafId = requestAnimationFrame(loop);
}

/* restart loop safely */
function resumeLoop(){
  if(gameOver || isPaused || isPausedForQuestion || !gameStarted) return;
  if(rafId) cancelAnimationFrame(rafId);
  rafId = requestAnimationFrame(loop);
  resumeBGM();
}

/* desktop keys */
document.addEventListener("keydown",e=>{
  if(!gameStarted || gameOver || isPaused || isPausedForQuestion || isClearingLines) return;

  if(e.key==="ArrowLeft" && valid(piece.matrix,piece.row,piece.col-1)) piece.col--;
  if(e.key==="ArrowRight"&& valid(piece.matrix,piece.row,piece.col+1)) piece.col++;
  if(e.key==="ArrowUp"){
    const r = rotate(piece.matrix);
    if(valid(r,piece.row,piece.col)) piece.matrix = r;
  }
  if(e.key==="ArrowDown"){
    if(valid(piece.matrix,piece.row+1,piece.col)) piece.row++;
  }
});

/* mobile buttons */
const moveLeftBtn  = document.getElementById("moveLeftBtn");
const moveRightBtn = document.getElementById("moveRightBtn");
const rotateBtn    = document.getElementById("rotateBtn");
const moveDownBtn  = document.getElementById("moveDownBtn");

function bind(btn, fn){
  if(!btn) return;
  btn.addEventListener("click", fn);
  btn.addEventListener("touchstart", (e)=>{ e.preventDefault(); fn(); }, {passive:false});
}
bind(moveLeftBtn, ()=>{ if(!isClearingLines && valid(piece.matrix,piece.row,piece.col-1)) piece.col--; });
bind(moveRightBtn,()=>{ if(!isClearingLines && valid(piece.matrix,piece.row,piece.col+1)) piece.col++; });
bind(rotateBtn,   ()=>{
  if(isClearingLines) return;
  const r = rotate(piece.matrix);
  if(valid(r,piece.row,piece.col)) piece.matrix = r;
});

/* tap down = 1, hold = fast */
let downHold=false, downTimer=null;
if(moveDownBtn){
  moveDownBtn.addEventListener("click", ()=>{
    if(!gameStarted || gameOver || isPaused || isPausedForQuestion || isClearingLines) return;
    if(valid(piece.matrix,piece.row+1,piece.col)) piece.row++;
    else lockPiece();
  });

  moveDownBtn.addEventListener("touchstart", (e)=>{
    e.preventDefault();
    if(!gameStarted || gameOver || isPaused || isPausedForQuestion || isClearingLines) return;

    downHold = true;
    if(valid(piece.matrix,piece.row+1,piece.col)) piece.row++;
    else lockPiece();

    downTimer = setInterval(()=>{
      if(!downHold) return;
      if(!gameStarted || gameOver || isPaused || isPausedForQuestion || isClearingLines) return;
      if(valid(piece.matrix,piece.row+1,piece.col)) piece.row++;
      else lockPiece();
    }, 55);
  }, {passive:false});

  const stopHold = ()=>{
    downHold = false;
    if(downTimer){ clearInterval(downTimer); downTimer=null; }
  };
  moveDownBtn.addEventListener("touchend", stopHold);
  moveDownBtn.addEventListener("touchcancel", stopHold);
}
</script>

<script>
/* ==============================
   QUESTION GATE (UPDATED)
   - ‚úÖ Questions shuffle
   - ‚úÖ Choices shuffle (correctIndex preserved)
   ============================== */

const QUESTIONS_RAW = [
  // ---- Core pronouns / basics ----
  { question: "„ÄåÁßÅÔºà„Çè„Åü„ÅóÔºâ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["I","me","my","you"], correctIndex: 0 },
  { question: "„Äå„ÅÇ„Å™„Åü„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["you","your","I","we"], correctIndex: 0 },
  { question: "„ÄåÂΩºÔºà„Åã„ÇåÔºâ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["he","him","his","she"], correctIndex: 0 },
  { question: "„ÄåÂΩºÂ•≥Ôºà„Åã„ÅÆ„Åò„ÇáÔºâ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["she","her","hers","he"], correctIndex: 0 },
  { question: "„ÄåÁßÅ„Åü„Å°„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["we","us","our","they"], correctIndex: 0 },
  { question: "„ÄåÂΩº„ÇâÔºèÂΩºÂ•≥„Çâ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["they","them","their","we"], correctIndex: 0 },

  // ---- Super common function words (harder / high-frequency) ----
  { question: "„Äå„Äú„ÅÆÔºè„Äú„Çí„Åô„ÇãÔºàÊåÅ„Å£„Å¶„ÅÑ„ÇãÔºâ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["have","make","take","give"], correctIndex: 0 },
  { question: "„Äå„Äú„Åß„ÅÇ„Çã„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["be","do","go","get"], correctIndex: 0 },
  { question: "„Äå„Äú„Åô„Çã„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["do","make","work","try"], correctIndex: 0 },
  { question: "„Äå„Äú„Å®Ë®Ä„ÅÜ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["say","tell","speak","talk"], correctIndex: 0 },
  { question: "„Äå„Äú„Å∏Ë°å„Åè„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["go","come","walk","move"], correctIndex: 0 },
  { question: "„Äå„ÄúÊù•„Çã„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["come","go","arrive","visit"], correctIndex: 0 },
  { question: "„Äå„ÄúË¶ã„Çã„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["see","look","watch","view"], correctIndex: 0 },
  { question: "„Äå„ÄúÁü•„Å£„Å¶„ÅÑ„Çã„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["know","think","learn","remember"], correctIndex: 0 },

  { question: "„Äå„Åù„Åó„Å¶„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["and","but","so","or"], correctIndex: 0 },
  { question: "„Äå„Åß„ÇÇÔºà„Åó„Åã„ÅóÔºâ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["but","and","or","so"], correctIndex: 0 },
  { question: "„Äå„Åæ„Åü„ÅØ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["or","and","but","so"], correctIndex: 0 },
  { question: "„Äå„Å†„Åã„Çâ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["so","because","but","or"], correctIndex: 0 },
  { question: "„Äå„Å™„Åú„Å™„Çâ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["because","so","but","then"], correctIndex: 0 },

  { question: "„Äå„Åì„ÅÆ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["this","that","these","those"], correctIndex: 0 },
  { question: "„Äå„Åù„ÅÆÔºà„ÅÇ„ÇåÔºâ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["that","this","those","these"], correctIndex: 0 },
  { question: "„Äå„Åì„Çå„Çâ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["these","those","this","that"], correctIndex: 0 },
  { question: "„Äå„ÅÇ„Çå„Çâ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["those","these","that","this"], correctIndex: 0 },

  { question: "„Äå„Åì„Åì„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["here","there","where","near"], correctIndex: 0 },
  { question: "„Äå„Åù„ÅìÔºè„ÅÇ„Åù„Åì„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["there","here","where","far"], correctIndex: 0 },
  { question: "„Äå„Å©„Åì„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["where","what","when","why"], correctIndex: 0 },
  { question: "„Äå„ÅÑ„Å§„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["when","where","who","why"], correctIndex: 0 },
  { question: "„Äå‰Ωï„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["what","who","when","where"], correctIndex: 0 },
  { question: "„Äå„Å†„Çå„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["who","what","when","where"], correctIndex: 0 },
  { question: "„Äå„Å©„ÅÜ„Åó„Å¶„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["why","what","where","when"], correctIndex: 0 },
  { question: "„Äå„Å©„ÅÜ„ÇÑ„Å£„Å¶„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["how","why","what","who"], correctIndex: 0 },

  { question: "„Äå„ÇÇ„Åó„Äú„Å™„Çâ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["if","because","when","that"], correctIndex: 0 },
  { question: "„Äå„Äú„ÅÆÊôÇ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["when","if","then","while"], correctIndex: 0 },
  { question: "„Äå„Äú„Å†„Åã„Çâ„Äç„ÅØËã±Ë™û„ÅßÔºüÔºàÁêÜÁî±Ôºâ", choices: ["because","so","but","or"], correctIndex: 0 },
  { question: "„Äå„Äú„Çà„Çä„ÇÇÔºàÊØîËºÉÔºâ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["than","then","that","when"], correctIndex: 0 },

  { question: "„Äå„Å®„Å¶„ÇÇ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["very","really","too","so"], correctIndex: 0 },
  { question: "„ÄåÊú¨ÂΩì„Å´„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["really","very","surely","truly"], correctIndex: 0 },
  { question: "„Äå„Äú„Åô„Åé„Çã„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["too","very","so","much"], correctIndex: 0 },
  { question: "„Äå„Åü„Åè„Åï„ÇìÔºàÈáèÔºâ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["much","many","lot","more"], correctIndex: 0 },
  { question: "„Äå„Åü„Åè„Åï„ÇìÔºàÊï∞Ôºâ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["many","much","more","most"], correctIndex: 0 },
  { question: "„Äå„ÇÇ„Å£„Å®„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["more","most","many","much"], correctIndex: 0 },
  { question: "„Äå„ÅÑ„Å°„Å∞„Çì„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["most","best","more","top"], correctIndex: 0 },

  { question: "„Äå„Äú„ÅÆ‰∏≠„Åß„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["in","on","at","by"], correctIndex: 0 },
  { question: "„Äå„Äú„ÅÆ‰∏ä„Å´„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["on","in","at","under"], correctIndex: 0 },
  { question: "„Äå„Äú„Å∏ÔºàÊñπÂêëÔºâ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["to","for","with","from"], correctIndex: 0 },
  { question: "„Äå„Äú„Åã„Çâ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["from","to","for","by"], correctIndex: 0 },
  { question: "„Äå„Äú„Å®‰∏ÄÁ∑í„Å´„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["with","for","by","from"], correctIndex: 0 },
  { question: "„Äå„Äú„ÅÆ„Åü„ÇÅ„Å´„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["for","to","with","from"], correctIndex: 0 },
  { question: "„Äå„Äú„Å´„Çà„Å£„Å¶Ôºè„Äú„ÅßÔºàÊâãÊÆµÔºâ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["by","with","from","to"], correctIndex: 0 },
  { question: "„Äå„Äú„Å´„Å§„ÅÑ„Å¶„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["about","around","over","after"], correctIndex: 0 },

  { question: "„Äå„Äú„Åß„Åç„Çã„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["can","may","must","should"], correctIndex: 0 },
  { question: "„Äå„Äú„Åó„Å™„Åë„Çå„Å∞„Å™„Çâ„Å™„ÅÑ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["must","can","may","should"], correctIndex: 0 },
  { question: "„Äå„Äú„Åó„Åü„Åª„ÅÜ„Åå„ÅÑ„ÅÑ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["should","must","can","may"], correctIndex: 0 },

  { question: "„Äå„ÅÑ„Å§„ÇÇ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["always","often","usually","sometimes"], correctIndex: 0 },
  { question: "„Äå„Çà„ÅèÔºàÈ†ªÂ∫¶Ôºâ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["often","always","never","rarely"], correctIndex: 0 },
  { question: "„Äå„Åü„ÅÑ„Å¶„ÅÑ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["usually","always","often","sometimes"], correctIndex: 0 },
  { question: "„Äå„Å®„Åç„Å©„Åç„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["sometimes","usually","often","always"], correctIndex: 0 },
  { question: "„ÄåÊ±∫„Åó„Å¶„Äú„Å™„ÅÑ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["never","always","often","rarely"], correctIndex: 0 },

  { question: "„Äå‰ªäÔºà„ÅÑ„ÅæÔºâ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["now","today","soon","then"], correctIndex: 0 },
  { question: "„Äå‰ªäÊó•Ôºà„Åç„Çá„ÅÜÔºâ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["today","now","tonight","this day"], correctIndex: 0 },
  { question: "„Äå‰ªäÂ§úÔºà„Åì„Çì„ÇÑÔºâ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["tonight","today","now","tomorrow"], correctIndex: 0 },
  { question: "„ÄåÊòéÊó•Ôºà„ÅÇ„Åó„ÅüÔºâ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["tomorrow","today","next day","soon"], correctIndex: 0 },
  { question: "„ÄåÊò®Êó•Ôºà„Åç„ÅÆ„ÅÜÔºâ„Äç„ÅØËã±Ë™û„ÅßÔºü", choices: ["yesterday","last day","past","before"], correctIndex: 0 },

  // ---- You can keep adding more like this (the shuffle logic below will handle everything) ----
];

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

let QUESTIONS = [];
function buildQuestions(){
  QUESTIONS = shuffle(QUESTIONS_RAW.slice());
  if(!QUESTIONS.length) QUESTIONS = QUESTIONS_RAW.slice();
}
buildQuestions();

const qOverlay = document.getElementById("questionOverlay");
const qText = document.getElementById("questionText");
const choiceWrap = document.getElementById("choiceWrap");

let firstTry = true;
let questionOpen = false;

function maybeTriggerQuestion(){
  if(isClearingLines) return;
  const threshold = (currentQuestionIndex + 1) * 5;
  if(linesClearedTotal >= threshold){
    showQuestion();
  }
}

function showQuestion(){
  if(questionOpen) return;
  questionOpen = true;

  isPausedForQuestion = true;
  firstTry = true;

  pauseBGM();
  safePlay(SFX.quizOpen);

  if(currentQuestionIndex % QUESTIONS.length === 0){
    buildQuestions();
  }

  const q = QUESTIONS[currentQuestionIndex % QUESTIONS.length];

  qText.textContent = q.question;
  choiceWrap.innerHTML = "";

  // ‚úÖ Build choice objects with ORIGINAL index preserved, then shuffle
  const choiceObjs = q.choices.map((txt, originalIndex)=>({ txt, originalIndex }));
  shuffle(choiceObjs);

  choiceObjs.forEach((c)=>{
    const b = document.createElement("button");
    b.className = "choiceBtn";
    b.type = "button";
    b.textContent = c.txt;

    b.addEventListener("click", ()=>{
      if(c.originalIndex === q.correctIndex){
        b.classList.add("correct");
        safePlay(SFX.quizCorrect);

        if(firstTry){
          score += 100;
          updateGravity();
          updateHud();
        }

        setTimeout(()=>{
          qOverlay.style.display = "none";
          isPausedForQuestion = false;
          currentQuestionIndex++;
          updateHud();

          questionOpen = false;
          resumeLoop();
        }, 420);

      } else {
        b.classList.add("wrong");
        firstTry = false;
        setTimeout(()=>b.classList.remove("wrong"), 260);
      }
    });

    choiceWrap.appendChild(b);
  });

  qOverlay.style.display = "flex";
}


/* ==============================
   PAUSE / HELP / LEADERBOARD
   ============================== */
const pauseBtn = document.getElementById("pauseBtn");
const pauseOverlay = document.getElementById("pauseOverlay");
pauseBtn.onclick = ()=>{
  if(!gameStarted || gameOver) return;
  isPaused = !isPaused;
  pauseOverlay.style.display = isPaused ? "flex" : "none";
  if(isPaused) pauseBGM();
  if(!isPaused) resumeLoop();
};
pauseOverlay.onclick = ()=>{ isPaused=false; pauseOverlay.style.display="none"; resumeLoop(); };

const helpBtn = document.getElementById("helpBtn");
const helpOverlay = document.getElementById("helpOverlay");
const helpClose = document.getElementById("helpClose");
helpBtn.onclick = ()=>{
  if(!gameStarted || gameOver) return;
  isPaused = true;
  pauseBGM();
  pauseOverlay.style.display = "none";
  helpOverlay.style.display = "flex";
};
helpClose.onclick = ()=>{
  helpOverlay.style.display = "none";
  isPaused = false;
  resumeLoop();
};

const trophyBtn = document.getElementById("trophyBtn");
const leaderboardOverlay = document.getElementById("leaderboardOverlay");
const leaderClose = document.getElementById("leaderClose");
trophyBtn.onclick = ()=>{
  if(!gameStarted) return;
  isPaused = true;
  pauseBGM();
  leaderboardOverlay.style.display = "flex";
};
leaderClose.onclick = ()=>{
  leaderboardOverlay.style.display = "none";
  isPaused = false;
  resumeLoop();
};

/* ==============================
   START OVERLAY
   ============================== */
const startOverlay = document.getElementById("startOverlay");
const startInner = document.getElementById("startOverlayInner");

async function startGame(){
  if(gameStarted) return;

  await unlockAudioOnce();

  gameStarted = true;

  // set theme at start
  currentLevel = calcLevel();
  const t = LEVEL_THEMES[(currentLevel - 1) % LEVEL_THEMES.length];
  document.documentElement.style.setProperty("--pink", t.p);
  document.documentElement.style.setProperty("--aqua", t.s);

  tickGlow();
  updateHud();

  let count = 3;
  startInner.innerHTML = `<span class="big">${count}</span>`;

  const timer = setInterval(()=>{
    count--;
    if(count > 0){
      startInner.innerHTML = `<span class="big">${count}</span>`;
    }else{
      clearInterval(timer);
      startInner.innerHTML = `<span class="big">GO!</span>`;
      setTimeout(()=>{
        startOverlay.style.display = "none";
        updateHud();
        resumeLoop();
      }, 500);
    }
  }, 700);
}
startOverlay.addEventListener("click", startGame);
startOverlay.addEventListener("touchstart", (e)=>{ e.preventDefault(); startGame(); }, {passive:false});

/* init */
updateGravity();
updateHud();
</script>
</body>
</html>
